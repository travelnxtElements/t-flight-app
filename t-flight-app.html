<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../t-air-search/t-air-search-page.html">
<link rel="import" href="../t-confirmation-page/t-confirmation-failure-page.html">
<link rel="import" href="t-flight-result-page.html">
<link rel="import" href="../t-header/t-header.html">
<link rel="import" href="../t-header/t-header-search-recap.html">
<link rel="import" href="../t-header/t-flight-search-decorator.html">

<dom-module id="t-flight-app">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  
    <t-notify id="notify" message="No results found." type="warn"></t-notify>

    <app-route
      id="flightRoute"
      route="{{route}}" 
      pattern="/:page" 
      data="{{routeData}}"
      tail="{{subroute}}">
    </app-route>

    <iron-pages 
      role="main"
      selected="{{page}}"
      attr-for-selected="name"
      selected-attribute="visible">

      <t-air-search-page 
        id="searchPage"
        auth-token="[[authToken]]" 
        api-base-url="[[apiBaseUrl]]"
        api-url-format="[[apiUrlFormat]]"
        query-params="{{queryParams}}"
        search-id="{{searchId}}"
        book-date-difference="0"
        name="home"
        on-search-page-success="_callbackFlightSearch">
      </t-air-search-page>

      <t-flight-result-page
        name="results"
        search-id="[[searchId]]"
        api-base-url="[[apiBaseUrl]]"
        filter-icon="bgv:filter"
        disable-filter-icon="bgv:disable-filter"
        auth-token="[[authToken]]"
        site-logo-url="[[siteLogoUrl]]"
        search-criteria="{{searchCriteria}}"
        api-url-format="[[apiUrlFormat]]"
        flight-icon="[[flightIcon]]"
        flight-recap-data="[[flightRecapData]]"
        itinerary="{{selectedItinerary}}"
        show-twelve-hour-clock="[[hasAmPmTimeFormat]]"
        on-flight-select="_goToDetails">
        <t-header icon="[[headerBackIcon]]" url="[[siteUrl]]flight/">
            <t-header-search-recap recap-data="{{flightRecapData}}"></t-header-search-recap>
            <t-flight-search-decorator
                input="[[searchCriteria]]"
                output="{{flightRecapData}}">
            </t-flight-search-decorator>
        </t-header>
      </t-flight-result-page>

      <t-confirmation-failure-page
          id="failure"
          name="failure"
          home-page-url="[[siteUrl]]flight"
          results-page-url="[[siteUrl]]flight/categories"
          details-page-url="[[siteUrl]]flight/details"
          customer-care-number="[[customerCareNumber]]">
          <t-header
              icon="home"
              url="[[siteUrl]]flight"
              label="Confirmation"
              normal-heading>
          </t-header>
      </t-confirmation-failure-page>

    </iron-pages>

  </template>

  <script>
    Polymer({

      is: 't-flight-app',

      properties: {
        visible: {
          type: Boolean,
          value: false,
          notify: true
        },

        route: {
          type: Object,
          notify: true
        },

        page: {
          type: String,
          value: 'home',
          reflectToAttribute: true
        },

        hasAmPmTimeFormat: {
          type: Boolean,
          value: false
        },

        searchCriteria: {
          type: Object
        },

        siteAbsUrl: String
      },

      observers: [
        '__routePageChanged(route.path)'
      ],

      __routePageChanged: function (path) {
        // body...
      },

      _callbackFlightSearch: function (event) {
        this.searchCriteria = this.$.searchPage.searchRequest;
        this._goToResults();
      },

      _goToResults: function (e) {
        this.set('route.path', 'results');
      },

      _goToDetails: function (e) {
        this.selectedItinerary = e.detail;
        this.set('route.path', 'details');
      }

    });
  </script>
</dom-module>
